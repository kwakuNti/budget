# Main .htaccess for budgetly.online root directory
RewriteEngine On

# Redirect IP access to domain ROOT only
RewriteCond %{HTTP_HOST} ^18\.208\.215\.173$
RewriteRule ^(.*)$ https://budgetly.online/ [R=301,L]

# Disable directory browsing
Options -Indexes

# Handle root access - redirect to login
RewriteRule ^$ budget/templates/login.php [L]

# Clean URL Redirects - Remove /budget/templates/ and .php
# Redirect old URLs to clean URLs
RewriteCond %{THE_REQUEST} ^[A-Z]{3,}\s/budget/templates/([^/\s?]+)\.php[\s?] [NC]
RewriteRule ^ /%1? [R=301,L]

# Handle clean URLs internally
# Map clean URLs back to actual file locations

# Check templates directory FIRST (since that's where your main pages are)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{DOCUMENT_ROOT}/budget/templates/$1.php -f
RewriteRule ^([^/]+)/?$ budget/templates/$1.php [L]

# Then check root budget directory as fallback
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{DOCUMENT_ROOT}/budget/$1.php -f
RewriteRule ^([^/]+)/?$ budget/$1.php [L]

# Allow specific API endpoints
RewriteCond %{REQUEST_URI} ^/budget/actions/register\.php$
RewriteRule ^ - [L]

RewriteCond %{REQUEST_URI} ^/budget/actions/login\.php$
RewriteRule ^ - [L]

# Allow specific directories and files to be accessed directly
RewriteCond %{REQUEST_URI} ^/budget/public/
RewriteRule ^ - [L]

RewriteCond %{REQUEST_URI} ^/budget/api/
RewriteRule ^ - [L]

# Block direct access to other sensitive directories
RewriteRule ^budget/(config|db|includes|ajax|cron|logs)/?$ budget/templates/login.php [R=302,L]

# Block direct access to sensitive actions (except register and login)
RewriteCond %{REQUEST_URI} !^/budget/actions/(register|login)\.php$
RewriteRule ^budget/actions/?.*$ budget/templates/login.php [R=302,L]


